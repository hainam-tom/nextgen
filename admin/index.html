<!doctype html>

<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8" />
  <title>Vendly Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='dashboard.css') }}" rel="stylesheet">
</head>
<body class="p-4">
  <h1 class="mb-4">Admin Dashboard</h1>

  <!-- Auth bar -->
  <div class="d-flex align-items-center gap-2 mb-3">
    {% if user_email %}
      <span class="text-muted">Signed in as {{ user_email }}</span>
      <a class="btn btn-outline-secondary btn-sm" href="/logout">Sign out</a>
    {% else %}
      <a class="btn btn-outline-primary btn-sm" href="/login">Sign in with Google</a>
    {% endif %}
  </div>

  {% if not is_admin %}
    <div class="alert alert-warning">
      Youâ€™re not signed in as the admin (<code>{{ ADMIN_EMAIL or 'tom05012013@gmail.com' }}</code>). Actions are disabled.
    </div>
  {% endif %}

  <div class="card">
    <h2>Products</h2>
    <ul class="list-unstyled" id="productsList">
      {% for p in products %}
        <li>{{ p.name }} - {{ p.price }}</li>
      {% endfor %}
    </ul>
    <form id="productForm" class="mt-3" {{ '' if is_admin else 'onSubmit="return false;"' }}>
      <h3>Add Product</h3>
      <div class="mb-2"><input class="form-control" name="name" placeholder="Name" required></div>
      <div class="mb-2"><input class="form-control" name="price" placeholder="Price" required></div>
      <button class="btn btn-primary" {{ '' if is_admin else 'disabled' }}>Create</button>
    </form>
  </div>

  <div class="card">
    <h2>Accounts</h2>
    {% if is_admin %}
      <ul class="list-unstyled" id="accountsList">
        {% for a in accounts %}
          <li>{{ a.email }}{% if a.name %} - {{ a.name }}{% endif %}</li>
        {% endfor %}
      </ul>
      <form id="accountForm" class="mt-3">
        <h3>Create Account</h3>
        <div class="mb-2"><input class="form-control" name="email" placeholder="Email" required></div>
        <div class="mb-2"><input class="form-control" name="name" placeholder="Name"></div>
        <button class="btn btn-primary">Create</button>
      </form>
    {% else %}
      <p class="text-muted">Sign in as admin to view and manage accounts.</p>
    {% endif %}
  </div>

  <script type="module">
  import "{{ url_for('static', filename='adminAPI.js') }}";

  const productForm = document.getElementById('productForm');
  productForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const f = e.target;
    await window.AdminAPI.createProduct({ name: f.name.value, price: Number(f.price.value) });
    f.reset();
    location.reload();
  });

  const accountForm = document.getElementById('accountForm');
  accountForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const f = e.target;
    await window.AdminAPI.createAccount({ email: f.email.value, name: f.name.value });
    f.reset();
    location.reload();
  });
</script>

  <script>
    import "{{ url_for('static', filename='adminAPI.js') }}";
    // Minimal JS: uses session-protected endpoints
    const $ = (s, el=document)=>el.querySelector(s);

    async function refreshProducts(){
      try{
        const items = await window.AdminAPI.getProducts();
        $('#productsList').innerHTML = items.map(p=>`<li>${p.name} - ${p.price}</li>`).join('');
      }catch(e){ console.error(e); }
    }

    async function refreshAccounts(){
      const list = $('#accountsList');
      if(!list) return; // not visible for non-admin
      try{
        const users = await window.AdminAPI.getAccounts();
        list.innerHTML = users.map(u=>`<li>${u.email}${u.name?` - ${u.name}`:''}</li>`).join('');
      }catch(e){
        list.innerHTML = `<li class="text-danger">${e.message}</li>`;
      }
    }

    document.getElementById('productForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const f = e.target;
      try{
        await window.AdminAPI.createProduct({ name: f.name.value, price: Number(f.price.value) });
        f.reset();
        await refreshProducts();
      }catch(e){ alert(e.message); }
    });

    document.getElementById('accountForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const f = e.target;
      try{
        await window.AdminAPI.createAccount({ email: f.email.value, name: f.name.value });
        f.reset();
        await refreshAccounts();
      }catch(e){ alert(e.message); }
    });

    // Initial refresh after SSR snapshot
    refreshProducts();
    refreshAccounts();
  </script>
</body>
</html>
